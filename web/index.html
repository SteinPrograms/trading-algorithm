<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
</head>
<body>
    <!-- TradingView Widget BEGIN -->
    <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
        {
        "symbols": [
        {
            "description": "",
            "proName": "BINANCE:BTCUSDT"
        },
        {
            "description": "",
            "proName": "BINANCE:ETHUSDT"
        },
        {
            "description": "",
            "proName": "BINANCE:AVAXUSDT"
        },
        {
            "description": "",
            "proName": "BINANCE:FTMUSDT"
        },
        {
            "description": "",
            "proName": "BINANCE:ATOMUSDT"
        }
        ],
        "showSymbolLogo": true,
        "colorTheme": "light",
        "isTransparent": true,
        "displayMode": "adaptive",
        "locale": "en"
    }
        </script>
    </div>
    <!-- TradingView Widget END -->
    <div class="chart" id="trading-view-chart"></div>
    <style>
        body, html{
            height: 100%;
            width:100%;
            overflow: hidden;
            display:flex;
            flex-direction: column;
        }
        .chart{
            width:100%;
            height: 100%;
            margin:0 auto;
        }
    </style>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        function convertToData(response){
            // [
            //   [
            //     1499040000000,      // Kline open time
            //     "0.01634790",       // Open price
            //     "0.80000000",       // High price
            //     "0.01575800",       // Low price
            //     "0.01577100",       // Close price
            //     "148976.11427815",  // Volume
            //     1499644799999,      // Kline Close time
            //     "2434.19055334",    // Quote asset volume
            //     308,                // Number of trades
            //     "1756.87402397",    // Taker buy base asset volume
            //     "28.46694368",      // Taker buy quote asset volume
            //     "0"                 // Unused field, ignore.
            //   ]
            // ]
            const data = []
            response.map(elem => {
                const date = new Date(elem[0])
                data.push({ time: date/1000 , open: elem[1] , high: elem[2] , low: elem[3] , close: elem[4] })
            });
            return data
        }

        function updateChart(series){
            const response = fetch(
            "https://data-api.binance.vision/api/v3/klines?"+ 
            new URLSearchParams({
                symbol: 'BTCUSDT',
                interval: '1h',
            }))
            .then(
                response => {
                    response.json().then(
                        response => {
                            elem = response[response.length-1]
                            const date = new Date(elem[0])
                            series.update({ time: date/1000 , open: elem[1] , high: elem[2] , low: elem[3] , close: elem[4] })
                        })
                    })
        }
        const response = fetch(
            "https://data-api.binance.vision/api/v3/klines?"+ 
            new URLSearchParams({
                symbol: 'BTCUSDT',
                interval: '1h',
            }))
        .then(
            response => {
                response.json().then(
                    response => {
                        var chart = LightweightCharts.createChart("trading-view-chart", {
                            timeScale: {
                                timeVisible: true,
                                borderColor: '#D1D4DC',
                            },
                            rightPriceScale: {
                                borderColor: '#D1D4DC',
                            },
                            watermark: {
                                visible: true,
                                fontSize: 24,
                                horzAlign: 'center',
                                vertAlign: 'center',
                                color: 'rgba(171, 71, 188, 0.5)',
                                text: 'BTCUSDT from Binance',
                            },
                            layout: {
                                background: {
                                    type: 'solid',
                                    color: '#ffffff',
                                },
                                textColor: '#000',
                            },
                            grid: {
                                horzLines: {
                                    color: '#F0F3FA',
                                },
                                vertLines: {
                                    color: '#F0F3FA',
                                },
                            },
                            }
                        );

                        var series = chart.addCandlestickSeries(
                            {
                                upColor: 'rgb(38,166,154)',
                                downColor: 'rgb(255,82,82)',
                                wickUpColor: 'rgb(38,166,154)',
                                wickDownColor: 'rgb(255,82,82)',
                                borderVisible: false,
                            }
                        );
                        const marketData = convertToData(response)
                        series.setData(marketData);
                        markers = [
                            { time: marketData[marketData.length -5].time, position: 'aboveBar', color: '#e91e63', shape: 'arrowDown', text: 'Sell @ '},
                            { time: marketData[marketData.length -15].time, position: 'belowBar', color: '#2196F3', shape: 'arrowUp', text: 'Buy @ '}
                        ]

                        series.setMarkers(markers);
                        setInterval(()=>{updateChart(series)},500) 
                    }
                )
            }
        )





        


    </script>
</body>
</html>