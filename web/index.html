<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
</head>
<body>
    <!-- TradingView Widget BEGIN -->
    <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
        {
        "symbols": [
        {
            "description": "",
            "proName": "BINANCE:BTCUSDT"
        },
        {
            "description": "",
            "proName": "BINANCE:ETHUSDT"
        },
        {
            "description": "",
            "proName": "BINANCE:AVAXUSDT"
        },
        {
            "description": "",
            "proName": "BINANCE:FTMUSDT"
        },
        {
            "description": "",
            "proName": "BINANCE:ATOMUSDT"
        }
        ],
        "showSymbolLogo": true,
        "colorTheme": "light",
        "isTransparent": true,
        "displayMode": "adaptive",
        "locale": "en"
    }
        </script>
    </div>
    <!-- TradingView Widget END -->
    <div class="chart" id="trading-view-chart"></div>
    <style>
        body, html{
            height: 100%;
            width:100%;
            overflow: hidden;
            display:flex;
            flex-direction: column;
        }
        .chart{
            width:100%;
            height: 100%;
            margin:0 auto;
        }
    </style>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>

        async function getPositions(){
            const positionsRequest = await fetch("http://localhost:5050");
            const positions = await positionsRequest.json();
            return positions
        }



        function formatKlines(klines){
            const data = []
            klines.map(elem => {
                const date = new Date(elem[0])
                data.push({ time: date/1000 , open: elem[1] , high: elem[2] , low: elem[3] , close: elem[4] })
            });
            return data
        }

        function updateChart(series){
            const response = fetch(
            "https://data-api.binance.vision/api/v3/klines?"+ 
            new URLSearchParams({
                symbol: 'BTCUSDT',
                interval: '1h',
            }))
            .then(
                response => {
                    response.json().then(
                        response => {
                            elem = response[response.length-1]
                            const date = new Date(elem[0])
                            series.update({ time: date/1000 , open: elem[1] , high: elem[2] , low: elem[3] , close: elem[4] })
                        })
                    })
        }
        
        async function createChart(){
            const klines_request = await fetch(
                "https://data-api.binance.vision/api/v3/klines?"+ 
                new URLSearchParams({
                    symbol: 'BTCUSDT',
                    interval: '1h',
                })
            )

            const klines = await klines_request.json()
            const marketData = formatKlines(klines)


            var chart = LightweightCharts.createChart("trading-view-chart", {
                timeScale: {
                    timeVisible: true,
                    borderColor: '#D1D4DC',
                },
                rightPriceScale: {
                    borderColor: '#D1D4DC',
                },
                watermark: {
                    visible: true,
                    fontSize: 24,
                    horzAlign: 'center',
                    vertAlign: 'center',
                    color: 'rgba(171, 71, 188, 0.5)',
                    text: '',
                },
                layout: {
                    background: {
                        type: 'solid',
                        color: '#ffffff',
                    },
                    textColor: '#000',
                },
                grid: {
                    horzLines: {
                        color: '#ffffff',
                    },
                    vertLines: {
                        color: '#ffffff',
                    },
                },
                }
            );

            var series = chart.addCandlestickSeries(
                {
                    upColor: 'rgb(38,166,154)',
                    downColor: 'rgb(255,82,82)',
                    wickUpColor: 'rgb(38,166,154)',
                    wickDownColor: 'rgb(255,82,82)',
                    borderVisible: false,
                }
            );
            series.setData(marketData);
            const markers = []
            const positions = await getPositions();
            for (position of positions){
                markers.push({ time: Date.parse(position.open_date)/1000, position: 'aboveBar', color: '#e91e63', shape: 'arrowDown', text: 'Sell @ '+position.close_price})
                markers.push({ time: Date.parse(position.close_date)/1000, position: 'belowBar', color: '#2196F3', shape: 'arrowUp', text: 'Buy @ '+position.open_price})
            }

            series.setMarkers(markers);
            setInterval(()=>{updateChart(series)},500) 
        }
        
        
        
        
        createChart()






        


    </script>
</body>
</html>